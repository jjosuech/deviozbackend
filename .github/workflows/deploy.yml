name: Build and Deploy Devioz Backend

on:
  push:
    branches: [ "main" ]

permissions:
  contents: read
  packages: write

jobs:
  build-and-push-image:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      # ========================================
      # LOGIN Y OBTENER SECRETOS DESDE VAULT
      # ========================================
      - name: Install Vault and jq
        run: |
          sudo apt-get update
          sudo apt-get install -y wget unzip jq
          wget https://releases.hashicorp.com/vault/1.15.5/vault_1.15.5_linux_amd64.zip
          unzip vault_1.15.5_linux_amd64.zip
          sudo mv vault /usr/local/bin/vault
          vault --version

      - name: Login to Vault and fetch secrets
        env:
          VAULT_ADDR: ${{ secrets.VAULT_ADDR }}
          ROLE_ID: ${{ secrets.VAULT_ROLE_ID }}
          SECRET_ID: ${{ secrets.VAULT_SECRET_ID }}
        run: |
          CLIENT_TOKEN=$(vault write auth/approle/login role_id=$ROLE_ID secret_id=$SECRET_ID -format=json | jq -r '.auth.client_token')
          
          export VAULT_TOKEN=$CLIENT_TOKEN
          
          echo "VAULT_TOKEN=$CLIENT_TOKEN" >> $GITHUB_ENV
          
          # âœ… FORZAR KV v1 CON curl (NO kv get)
          DB_PASSWORD=$(vault read -field=DB_PASSWORD secret/prod/db)
          MASTER_KEY=$(vault read -field=MASTER_KEY secret/prod/master)
          
          echo "DB_PASSWORD=$DB_PASSWORD" >> $GITHUB_ENV
          echo "MASTER_KEY=$MASTER_KEY" >> $GITHUB_ENV

      # ========================================
      # LOGIN A AZURE PARA OBTENER OTROS SECRETOS
      # ========================================
      - name: Login to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Fetch MASTER_KEY from Key Vault
        run: |
          MASTER_KEY=$(az keyvault secret show --name devioz_master_key --vault-name josue-keyvault --query value -o tsv)
          echo "MASTER_KEY=$MASTER_KEY" >> $GITHUB_ENV


      # ========================================
      # DOCKER BUILD & PUSH
      # ========================================
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build Docker image
        run: |
          docker build \
            --build-arg DB_PASSWORD=${{ env.DB_PASSWORD }} \
            --build-arg MASTER_KEY=${{ env.MASTER_KEY }} \
            -t ghcr.io/jjosuech/deviozbackend:latest .

      - name: Push Docker image
        run: |
          docker push ghcr.io/jjosuech/deviozbackend:latest

  # ========================================
  # DEPLOY A VM
  # ========================================
  deploy-to-vm:
    needs: build-and-push-image
    runs-on: ubuntu-latest

    steps:
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.8.1
        with:
          ssh-private-key: ${{ secrets.VM_SSH_PRIVATE_KEY }}

      - name: Deploy Docker container on VM
        run: |
          ssh azureuser@4.174.128.87 << 'EOF'
            docker rm -f devioz-backend || true
            echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            docker pull ghcr.io/jjosuech/deviozbackend:latest
            docker tag ghcr.io/jjosuech/deviozbackend:latest deviozbackend:latest
            docker run -d \
              --name devioz-backend \
              -p 8081:8081 \
              -e DB_PASSWORD='${{ env.DB_PASSWORD }}' \
              -e MASTER_KEY='${{ env.MASTER_KEY }}' \
              deviozbackend:latest
          EOF
